<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINT Galaxy Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            cursor: crosshair;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            background: radial-gradient(ellipse at center, #0a0b1e 0%, #000 100%);
        }

        /* GALAXY BACKGROUND */
        .galaxy-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        .star.small {
            width: 1px;
            height: 1px;
            opacity: 0.6;
        }

        .star.medium {
            width: 2px;
            height: 2px;
            opacity: 0.8;
            box-shadow: 0 0 4px #fff;
        }

        .star.large {
            width: 3px;
            height: 3px;
            opacity: 1;
            box-shadow: 0 0 8px #00f5ff;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(20px);
            animation: drift 20s infinite linear;
            pointer-events: none;
        }

        .nebula1 {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(0,245,255,0.1) 0%, transparent 70%);
            top: 20%;
            left: 10%;
        }

        .nebula2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(128,0,255,0.08) 0%, transparent 70%);
            top: 60%;
            right: 15%;
            animation-delay: -10s;
        }

        .nebula3 {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,0,128,0.06) 0%, transparent 70%);
            bottom: 30%;
            left: 70%;
            animation-delay: -15s;
        }

        @keyframes drift {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, -30px) rotate(90deg); }
            50% { transform: translate(-20px, 40px) rotate(180deg); }
            75% { transform: translate(-40px, -20px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            backdrop-filter: blur(30px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
        }

        .logo {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(45deg, #00f5ff, #0080ff, #8000ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .stats {
            display: flex;
            gap: 25px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
        }

        .stat-value {
            color: #00f5ff;
            margin-left: 6px;
        }

        .mode-indicator {
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(0,245,255,0.2);
            border: 1px solid rgba(0,245,255,0.4);
            border-radius: 20px;
            color: #00f5ff;
        }

        /* CONTEXT MENU */
        .context-menu {
            position: fixed;
            background: rgba(10,10,15,0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(0,245,255,0.3);
            border-radius: 16px;
            padding: 8px;
            z-index: 1000;
            display: none;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            min-width: 300px;
        }

        .menu-section {
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 8px 12px 4px;
            margin-bottom: 4px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }

        .menu-item:hover {
            background: rgba(0,245,255,0.15);
            color: #00f5ff;
            transform: translateX(4px);
        }

        .menu-item.danger:hover {
            background: rgba(255,0,80,0.15);
            color: #ff0050;
        }

        .menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .menu-item.disabled:hover {
            background: transparent;
            color: rgba(255,255,255,0.9);
            transform: none;
        }

        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .submenu {
            display: none;
            margin-left: 20px;
            margin-top: 4px;
            border-left: 2px solid rgba(0,245,255,0.2);
            padding-left: 12px;
        }

        .submenu.open {
            display: block;
        }

        .submenu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .submenu-item:hover {
            background: rgba(0,245,255,0.1);
            color: #00f5ff;
        }

        /* CREATION MODAL */
        .creation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: rgba(15,15,20,0.95);
            backdrop-filter: blur(40px);
            border: 2px solid rgba(0,245,255,0.3);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.7);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(45deg, #00f5ff, #8000ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #00f5ff;
            background: rgba(0,245,255,0.05);
            box-shadow: 0 0 0 4px rgba(0,245,255,0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00f5ff, #8000ff);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,245,255,0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        /* CONNECTION MODE */
        .connection-mode {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15,15,20,0.9);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(0,245,255,0.4);
            border-radius: 20px;
            padding: 12px 20px;
            color: #00f5ff;
            font-size: 14px;
            font-weight: 600;
            display: none;
            z-index: 150;
        }

        /* THREAD MODE */
        .thread-mode {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(128,0,255,0.2);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(128,0,255,0.4);
            border-radius: 20px;
            padding: 12px 20px;
            color: #8000ff;
            font-size: 14px;
            font-weight: 600;
            display: none;
            z-index: 150;
        }

        /* ANIMATIONS */
        @keyframes nodeAppear {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .node-appear {
            animation: nodeAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 10px currentColor; }
            50% { box-shadow: 0 0 20px currentColor; }
        }

        .selected {
            animation: pulseGlow 2s infinite;
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .icon-person { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'); }
        .icon-email { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'); }
        .icon-phone { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>'); }
        .icon-location { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'); }
        .icon-domain { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>'); }
        .icon-document { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>'); }
        .icon-ip { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M4,6H20V16H4M20,18A2,2 0 0,0 22,16V6C22,4.89 21.1,4 20,4H4C2.89,4 2,4.89 2,6V16A2,2 0 0,0 4,18H0V20H24V18H20Z"/></svg>'); }
        .icon-custom { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>'); }

        /* Social Media Icons */
        .icon-facebook { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>'); }
        .icon-twitter { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>'); }
        .icon-linkedin { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>'); }
        .icon-instagram { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>'); }
        .icon-telegram { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 0C5.376 0 0 5.376 0 12s5.376 12 12 12 12-5.376 12-12S18.624 0 12 0zm5.568 8.16c-.169 1.858-.896 6.728-.896 6.728-.302 1.39-1.5 1.96-1.5 1.96s-1.59-.755-2.295-1.21c-.765-.495-1.196-.735-1.914-1.225-.873-.6-.3-1.49.195-1.97L15.94 9.3c.465-.45.195-.705-.3-.465L9.3 12.615s-.96.3-1.11.06c-.165-.27-.345-.42-.69-.57-.48-.225-1.005-.345-1.005-.345s-.72-.45-.48-1.005c.225-.51 1.38-.99 1.38-.99L18.87 6.9s1.275-.54 1.275.255c0 .3-.045.705-.577 1.005z"/></svg>'); }
        .icon-whatsapp { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.150-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.463 3.488"/></svg>'); }
        .icon-vkontakte { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1.01-1.49-.9-1.744-.9-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4.03 8.57 4.03 8.096c0-.254.102-.491.593-.491h1.744c.441 0 .61.203.78.677.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.204.169-.407.44-.407h2.744c.373 0 .508.203.508.644v3.473c0 .373.169.508.271.508.22 0 .407-.135.813-.542 1.254-1.406 2.151-3.574 2.151-3.574.119-.254.322-.491.763-.491h1.744c.525 0 .644.271.525.644-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg>'); }
        .icon-github { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>'); }
        .icon-discord { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.196.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>'); }
        .icon-youtube { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>'); }
        .icon-tiktok { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>'); }

        /* MUSIC PANEL */
        .music-panel {
            position: fixed;
            top: 60px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 50%;
            border: 1px solid rgba(0, 245, 255, 0.4);
            z-index: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
        }

        .music-panel.expanded {
            width: 280px;
            height: 200px;
            border-radius: 20px;
        }

        .music-toggle {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #00f5ff;
            z-index: 10;
        }

        .music-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px 15px 15px 50px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .music-panel.expanded .music-content {
            opacity: 1;
            pointer-events: all;
        }

        .music-title {
            font-size: 16px;
            font-weight: 700;
            color: #00f5ff;
            margin-bottom: 15px;
            text-align: center;
        }

        .track-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #00f5ff;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: none;
            border: none;
            color: #00f5ff;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            transform: scale(1.1);
        }

        .play-btn {
            font-size: 24px;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-icon {
            color: #00f5ff;
            font-size: 14px;
        }

        .volume-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00f5ff;
            cursor: pointer;
        }

        .track-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .track-item {
            padding: 5px 10px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-item:hover {
            background: rgba(0, 245, 255, 0.1);
        }

        .track-item.active {
            color: #00f5ff;
            background: rgba(0, 245, 255, 0.15);
        }

        /* FPS COUNTER */
        .fps-counter {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #00ff40;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- GALAXY BACKGROUND -->
        <div class="galaxy-bg" id="galaxyBg">
            <div class="nebula nebula1"></div>
            <div class="nebula nebula2"></div>
            <div class="nebula nebula3"></div>
        </div>

        <!-- CANVAS -->
        <canvas id="canvas"></canvas>

        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="logo">GALAXY·OSINT</div>
            
            <div class="stats">
                <span>Узлы: <span class="stat-value" id="nodeCount">0</span></span>
                <span>Связи: <span class="stat-value" id="edgeCount">0</span></span>
                <span>Нити: <span class="stat-value" id="threadCount">0</span></span>
            </div>
            
            <div class="mode-indicator" id="modeIndicator">
                Режим создания
            </div>
        </div>

        <!-- CONTEXT MENU -->
        <div class="context-menu" id="contextMenu">
            <div class="menu-section">
                <div class="section-title">Создать</div>
                <div class="menu-item" onclick="openNodeCreator()">
                    <div class="menu-icon icon icon-custom"></div>
                    <div class="menu-text">Новый узел</div>
                </div>
                <div class="menu-item" onclick="toggleSubmenu('nodeTypes')">
                    <div class="menu-icon">⚡</div>
                    <div class="menu-text">Быстрое создание</div>
                </div>
                <div class="submenu" id="nodeTypes">
                    <div class="submenu-item" onclick="quickCreateNode('person')">
                        <div class="icon icon-person"></div>
                        Персона
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('email')">
                        <div class="icon icon-email"></div>
                        Email
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('phone')">
                        <div class="icon icon-phone"></div>
                        Телефон
                    </div>
                    <div class="submenu-item" onclick="toggleSubmenu('socialTypes')">
                        <div class="icon icon-facebook"></div>
                        Социальные сети ▶
                    </div>
                    <div class="submenu" id="socialTypes">
                        <div class="submenu-item" onclick="quickCreateNode('facebook')">
                            <div class="icon icon-facebook"></div>
                            Facebook
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('twitter')">
                            <div class="icon icon-twitter"></div>
                            Twitter/X
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('instagram')">
                            <div class="icon icon-instagram"></div>
                            Instagram
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('linkedin')">
                            <div class="icon icon-linkedin"></div>
                            LinkedIn
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('telegram')">
                            <div class="icon icon-telegram"></div>
                            Telegram
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('whatsapp')">
                            <div class="icon icon-whatsapp"></div>
                            WhatsApp
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('vkontakte')">
                            <div class="icon icon-vkontakte"></div>
                            VKontakte
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('youtube')">
                            <div class="icon icon-youtube"></div>
                            YouTube
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('tiktok')">
                            <div class="icon icon-tiktok"></div>
                            TikTok
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('discord')">
                            <div class="icon icon-discord"></div>
                            Discord
                        </div>
                        <div class="submenu-item" onclick="quickCreateNode('github')">
                            <div class="icon icon-github"></div>
                            GitHub
                        </div>
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('domain')">
                        <div class="icon icon-domain"></div>
                        Домен
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('location')">
                        <div class="icon icon-location"></div>
                        Локация
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('document')">
                        <div class="icon icon-document"></div>
                        Документ
                    </div>
                    <div class="submenu-item" onclick="quickCreateNode('ip')">
                        <div class="icon icon-ip"></div>
                        IP адрес
                    </div>
                </div>
            </div>

            <div class="menu-section">
                <div class="section-title">Связи</div>
                <div class="menu-item" onclick="enterConnectionMode()">
                    <div class="menu-icon">🔗</div>
                    <div class="menu-text">Обычные связи</div>
                </div>
                <div class="menu-item" onclick="enterThreadMode()">
                    <div class="menu-icon">⎯</div>
                    <div class="menu-text">Нити связей</div>
                </div>
            </div>

            <div class="menu-section" id="nodeActionsSection" style="display: none;">
                <div class="section-title">Выбранный узел</div>
                <div class="menu-item" onclick="editSelectedNode()">
                    <div class="menu-icon">✎</div>
                    <div class="menu-text">Редактировать</div>
                </div>
                <div class="menu-item" onclick="duplicateSelectedNode()">
                    <div class="menu-icon">⧉</div>
                    <div class="menu-text">Дублировать</div>
                </div>
                <div class="menu-item danger" onclick="deleteSelectedNode()">
                    <div class="menu-icon">✕</div>
                    <div class="menu-text">Удалить узел</div>
                </div>
                <div class="menu-item" onclick="isolateNode()">
                    <div class="menu-icon">⌕</div>
                    <div class="menu-text">Изолировать</div>
                </div>
                <div class="menu-item" onclick="showNodeConnections()">
                    <div class="menu-icon">⊞</div>
                    <div class="menu-text">Показать связи</div>
                </div>
            </div>

            <div class="menu-section">
                <div class="section-title">Действия</div>
                <div class="menu-item" onclick="selectAll()">
                    <div class="menu-icon">☑</div>
                    <div class="menu-text">Выбрать все</div>
                </div>
                <div class="menu-item" onclick="exportData()">
                    <div class="menu-icon">⤓</div>
                    <div class="menu-text">Экспорт данных</div>
                </div>
                <div class="menu-item" onclick="importData()">
                    <div class="menu-icon">⤒</div>
                    <div class="menu-text">Импорт данных</div>
                </div>
                <div class="menu-item" onclick="takeScreenshot()">
                    <div class="menu-icon">🖼</div>
                    <div class="menu-text">Скриншот</div>
                </div>
                <div class="menu-item" onclick="resetView()">
                    <div class="menu-icon">⟳</div>
                    <div class="menu-text">Сбросить вид</div>
                </div>
                <div class="menu-item danger" onclick="clearAll()">
                    <div class="menu-icon">🗙</div>
                    <div class="menu-text">Очистить все</div>
                </div>
            </div>
        </div>

        <!-- NODE CREATION MODAL -->
        <div class="creation-modal" id="creationModal">
            <div class="modal-content">
                <div class="modal-title">Создание узла</div>
                
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" class="form-input" id="nodeName" placeholder="Введите название узла..." autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Тип</label>
                    <select class="form-select" id="nodeType">
                        <option value="person">👤 Персона</option>
                        <option value="email">✉ Email</option>
                        <option value="phone">📞 Телефон</option>
                        <option value="facebook">📘 Facebook</option>
                        <option value="twitter">🐦 Twitter/X</option>
                        <option value="instagram">📷 Instagram</option>
                        <option value="linkedin">💼 LinkedIn</option>
                        <option value="telegram">📨 Telegram</option>
                        <option value="whatsapp">💬 WhatsApp</option>
                        <option value="vkontakte">🔵 VKontakte</option>
                        <option value="youtube">📺 YouTube</option>
                        <option value="tiktok">🎵 TikTok</option>
                        <option value="discord">🎮 Discord</option>
                        <option value="github">⚙ GitHub</option>
                        <option value="domain">🌐 Домен</option>
                        <option value="location">📍 Локация</option>
                        <option value="document">📄 Документ</option>
                        <option value="ip">🖧 IP адрес</option>
                        <option value="custom">⚙ Пользовательский</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Цвет</label>
                    <div class="color-grid">
                        <div class="color-option selected" style="background: #00f5ff" data-color="#00f5ff"></div>
                        <div class="color-option" style="background: #ff4000" data-color="#ff4000"></div>
                        <div class="color-option" style="background: #40ff00" data-color="#40ff00"></div>
                        <div class="color-option" style="background: #4000ff" data-color="#4000ff"></div>
                        <div class="color-option" style="background: #ff0040" data-color="#ff0040"></div>
                        <div class="color-option" style="background: #00ffff" data-color="#00ffff"></div>
                        <div class="color-option" style="background: #ff40ff" data-color="#ff40ff"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <input type="text" class="form-input" id="nodeDescription" placeholder="Дополнительная информация...">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                    <button class="btn btn-primary" onclick="createNode()">Создать узел</button>
                </div>
            </div>
        </div>

        <!-- CONNECTION MODE INDICATOR -->
        <div class="connection-mode" id="connectionMode">
            🔗 Режим связей: Кликните на два узла для создания связи
        </div>

        <!-- THREAD MODE INDICATOR -->
        <div class="thread-mode" id="threadMode">
            ⎯ Режим нитей: Создание тонких нитевидных связей
        </div>

        <!-- MUSIC PANEL -->
        <div class="music-panel" id="musicPanel">
            <div class="music-toggle">♪</div>
            <div class="music-content">
                <div class="music-title">Космические ритмы</div>
                <div class="track-info" id="trackInfo">Не выбрано</div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="music-controls">
                    <button class="control-btn" onclick="prevTrack()">⏮</button>
                    <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">▶</button>
                    <button class="control-btn" onclick="nextTrack()">⏭</button>
                </div>
                <div class="volume-container">
                    <div class="volume-icon">♪</div>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                </div>
                <div class="track-list" id="trackList"></div>
            </div>
        </div>

        <!-- FPS COUNTER -->
        <div class="fps-counter" id="fpsCounter">FPS: 0</div>

        <!-- Hidden file input for import -->
        <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">
    </div>

    <script>
        class GalaxyOSINT {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.nodes = new Map();
                this.edges = new Map();
                this.threads = new Map();
                this.selectedNodes = new Set();
                this.connectionMode = false;
                this.threadMode = false;
                this.connectionStart = null;
                this.mousePos = { x: 0, y: 0 };
                this.viewOffset = { x: 0, y: 0 };
                this.zoom = 1;
                this.isDragging = false;
                this.dragStart = { x: 0, y: 0 };
                this.rightClickedNode = null;
                
                // Оптимизационные переменные
                this.lastFrameTime = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                this.animationId = null;
                this.visibleNodes = new Set();
                
                this.initCanvas();
                this.createStars();
                this.setupEventListeners();
                this.startAnimation();
            }

            initCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = window.innerWidth * dpr;
                this.canvas.height = window.innerHeight * dpr;
                this.canvas.style.width = window.innerWidth + 'px';
                this.canvas.style.height = window.innerHeight + 'px';
                this.ctx.scale(dpr, dpr);
            }

            createStars() {
                const galaxyBg = document.getElementById('galaxyBg');
                
                // Create twinkling stars
                for (let i = 0; i < 300; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    
                    const size = Math.random();
                    if (size < 0.7) star.classList.add('small');
                    else if (size < 0.9) star.classList.add('medium');
                    else star.classList.add('large');
                    
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    
                    galaxyBg.appendChild(star);
                }
            }

            setupEventListeners() {
                // Mouse events
                this.canvas.addEventListener('contextmenu', (e) => this.onRightClick(e));
                this.canvas.addEventListener('click', (e) => this.onClick(e));
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));
                this.canvas.addEventListener('wheel', (e) => this.onWheel(e));
                
                // Keyboard events
                document.addEventListener('keydown', (e) => this.onKeyDown(e));
                
                // Window resize
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Click outside to close menu
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu') && !e.target.closest('.creation-modal')) {
                        this.hideContextMenu();
                    }
                });
            }

            startAnimation() {
                this.lastFrameTime = performance.now();
                this.animate();
            }

            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                // Рассчет FPS
                const now = performance.now();
                const deltaTime = now - this.lastFrameTime;
                this.lastFrameTime = now;
                this.frameCount++;
                
                if (now - this.lastFpsUpdate > 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (now - this.lastFpsUpdate));
                    document.getElementById('fpsCounter').textContent = `FPS: ${this.fps}`;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;
                }
                
                // Очистка холста
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Оптимизация: рисуем только видимые элементы
                this.calculateVisibleArea();
                
                // Рисование
                this.threads.forEach(thread => this.drawThread(thread));
                this.edges.forEach(edge => this.drawEdge(edge));
                
                // Рисуем только видимые узлы
                this.visibleNodes.forEach(nodeId => {
                    const node = this.nodes.get(nodeId);
                    if (node) this.drawNode(node);
                });
            }

            // Определение видимой области для оптимизации
            calculateVisibleArea() {
                this.visibleNodes.clear();
                
                const viewportLeft = -this.viewOffset.x / this.zoom;
                const viewportTop = -this.viewOffset.y / this.zoom;
                const viewportRight = viewportLeft + this.canvas.width / this.zoom;
                const viewportBottom = viewportTop + this.canvas.height / this.zoom;
                
                this.nodes.forEach((node, id) => {
                    if (node.hidden) return;
                    
                    const nodeLeft = node.x - node.radius;
                    const nodeRight = node.x + node.radius;
                    const nodeTop = node.y - node.radius;
                    const nodeBottom = node.y + node.radius;
                    
                    // Проверка пересечения с видимой областью
                    if (nodeRight > viewportLeft && nodeLeft < viewportRight &&
                        nodeBottom > viewportTop && nodeTop < viewportBottom) {
                        this.visibleNodes.add(id);
                    }
                });
            }

            onRightClick(event) {
                event.preventDefault();
                this.updateMousePos(event);
                
                // Check if we right-clicked on a node
                const clickedNode = this.getNodeAt(this.mousePos.x, this.mousePos.y);
                this.rightClickedNode = clickedNode;
                
                // Show/hide node-specific actions
                const nodeActionsSection = document.getElementById('nodeActionsSection');
                if (clickedNode) {
                    nodeActionsSection.style.display = 'block';
                    // Select the right-clicked node
                    this.selectedNodes.clear();
                    this.nodes.forEach(n => n.selected = false);
                    clickedNode.selected = true;
                    this.selectedNodes.add(clickedNode.id);
                } else {
                    nodeActionsSection.style.display = 'none';
                }
                
                this.showContextMenu(event.clientX, event.clientY);
            }

            onClick(event) {
                this.updateMousePos(event);
                
                const clickedNode = this.getNodeAt(this.mousePos.x, this.mousePos.y);
                
                if (this.connectionMode || this.threadMode) {
                    this.handleConnectionClick(clickedNode);
                } else {
                    this.handleNodeSelection(clickedNode);
                }
                
                this.hideContextMenu();
            }

            onMouseDown(event) {
                if (event.button === 0) { // Left click
                    this.isDragging = true;
                    this.dragStart.x = event.clientX - this.viewOffset.x;
                    this.dragStart.y = event.clientY - this.viewOffset.y;
                }
            }

            onMouseMove(event) {
                this.updateMousePos(event);
                
                if (this.isDragging && !this.connectionMode && !this.threadMode) {
                    this.viewOffset.x = event.clientX - this.dragStart.x;
                    this.viewOffset.y = event.clientY - this.dragStart.y;
                }
            }

            onMouseUp(event) {
                this.isDragging = false;
            }

            onWheel(event) {
                event.preventDefault();
                const zoomFactor = event.deltaY > 0 ? 0.9 : 1.1;
                this.zoom = Math.max(0.5, Math.min(3, this.zoom * zoomFactor));
            }

            onKeyDown(event) {
                if (document.getElementById('creationModal').style.display === 'flex') return;
                
                switch(event.key.toLowerCase()) {
                    case 'n':
                        this.openNodeCreator();
                        break;
                    case 'c':
                        this.enterConnectionMode();
                        break;
                    case 't':
                        this.enterThreadMode();
                        break;
                    case 'a':
                        if (event.ctrlKey || event.metaKey) {
                            event.preventDefault();
                            this.selectAll();
                        }
                        break;
                    case 'delete':
                    case 'backspace':
                        this.deleteSelected();
                        break;
                    case ' ':
                        event.preventDefault();
                        this.resetView();
                        break;
                    case 'escape':
                        this.exitAllModes();
                        this.hideContextMenu();
                        this.closeModal();
                        break;
                    case 's':
                        if (event.ctrlKey || event.metaKey) {
                            event.preventDefault();
                            this.exportData();
                        }
                        break;
                    case 'm':
                        const panel = document.getElementById('musicPanel');
                        panel.classList.toggle('expanded');
                        break;
                }
            }

            updateMousePos(event) {
                const rect = this.canvas.getBoundingClientRect();
                this.mousePos.x = (event.clientX - rect.left - this.viewOffset.x) / this.zoom;
                this.mousePos.y = (event.clientY - rect.top - this.viewOffset.y) / this.zoom;
            }

            showContextMenu(x, y) {
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = Math.min(x, window.innerWidth - 320) + 'px';
                menu.style.top = Math.min(y, window.innerHeight - 500) + 'px';
            }

            hideContextMenu() {
                document.getElementById('contextMenu').style.display = 'none';
                document.querySelectorAll('.submenu').forEach(sub => sub.classList.remove('open'));
            }

            openNodeCreator() {
                document.getElementById('creationModal').style.display = 'flex';
                document.getElementById('nodeName').focus();
                this.hideContextMenu();
            }

            closeModal() {
                document.getElementById('creationModal').style.display = 'none';
                document.getElementById('nodeName').value = '';
                document.getElementById('nodeDescription').value = '';
                document.getElementById('nodeType').selectedIndex = 0;
                
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                document.querySelector('.color-option').classList.add('selected');
            }

            createNode() {
                const name = document.getElementById('nodeName').value.trim();
                if (!name) {
                    alert('Введите название узла');
                    return;
                }
                
                const type = document.getElementById('nodeType').value;
                const description = document.getElementById('nodeDescription').value.trim();
                const selectedColor = document.querySelector('.color-option.selected').dataset.color;
                
                this.createCustomNode(name, type, selectedColor, description, this.mousePos);
                this.closeModal();
            }

            createCustomNode(name, type, color, description, position) {
                const nodeId = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const node = {
                    id: nodeId,
                    name: name,
                    type: type,
                    color: color,
                    description: description,
                    x: position.x,
                    y: position.y,
                    radius: 25,
                    selected: false,
                    connections: [],
                    createdAt: new Date().toISOString()
                };
                
                this.nodes.set(nodeId, node);
                this.updateStats();
                return node;
            }

            quickCreateNode(type) {
                const typeNames = {
                    person: 'Персона',
                    email: 'Email',
                    phone: 'Телефон',
                    facebook: 'Facebook',
                    twitter: 'Twitter/X',
                    instagram: 'Instagram',
                    linkedin: 'LinkedIn',
                    telegram: 'Telegram',
                    whatsapp: 'WhatsApp',
                    vkontakte: 'VKontakte',
                    youtube: 'YouTube',
                    tiktok: 'TikTok',
                    discord: 'Discord',
                    github: 'GitHub',
                    domain: 'Домен',
                    location: 'Локация',
                    document: 'Документ',
                    ip: 'IP адрес'
                };
                
                const typeColors = {
                    person: '#00f5ff',
                    email: '#00ff80',
                    phone: '#ff8000',
                    facebook: '#1877f2',
                    twitter: '#1da1f2',
                    instagram: '#e4405f',
                    linkedin: '#0077b5',
                    telegram: '#0088cc',
                    whatsapp: '#25d366',
                    vkontakte: '#4c75a3',
                    youtube: '#ff0000',
                    tiktok: '#ff0050',
                    discord: '#5865f2',
                    github: '#333333',
                    domain: '#ff0080',
                    location: '#ffff00',
                    document: '#ff4000',
                    ip: '#40ff00'
                };
                
                const name = `${typeNames[type]} ${this.nodes.size + 1}`;
                this.createCustomNode(name, type, typeColors[type], '', this.mousePos);
                this.hideContextMenu();
            }

            getNodeAt(x, y) {
                for (let [id, node] of this.nodes) {
                    const dx = x - node.x;
                    const dy = y - node.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance <= node.radius) {
                        return node;
                    }
                }
                return null;
            }

            handleNodeSelection(node) {
                if (node) {
                    if (node.selected) {
                        node.selected = false;
                        this.selectedNodes.delete(node.id);
                    } else {
                        node.selected = true;
                        this.selectedNodes.add(node.id);
                    }
                } else {
                    // Deselect all
                    this.selectedNodes.clear();
                    this.nodes.forEach(n => n.selected = false);
                }
            }

            handleConnectionClick(node) {
                if (node) {
                    if (!this.connectionStart) {
                        this.connectionStart = node;
                        node.selected = true;
                        const modeText = this.threadMode ? 'нити' : 'связи';
                        const indicator = this.threadMode ? 'threadMode' : 'connectionMode';
                        document.getElementById(indicator).innerHTML = 
                            `${this.threadMode ? '⎯' : '🔗'} Выбран узел: ${node.name}. Кликните на второй узел для создания ${modeText}.`;
                    } else {
                        if (this.connectionStart.id !== node.id) {
                            if (this.threadMode) {
                                this.createThread(this.connectionStart.id, node.id);
                            } else {
                                this.createConnection(this.connectionStart.id, node.id);
                            }
                        }
                        
                        this.connectionStart.selected = false;
                        this.connectionStart = null;
                        this.exitAllModes();
                    }
                }
            }

            createConnection(fromId, toId) {
                const edgeId = `${fromId}-${toId}`;
                if (this.edges.has(edgeId) || this.edges.has(`${toId}-${fromId}`)) return;
                
                const fromNode = this.nodes.get(fromId);
                const toNode = this.nodes.get(toId);
                
                if (!fromNode || !toNode) return;
                
                const edge = {
                    id: edgeId,
                    fromId: fromId,
                    toId: toId,
                    type: 'connection',
                    thickness: 3,
                    color: '#00f5ff',
                    opacity: 0.8,
                    createdAt: new Date().toISOString()
                };
                
                this.edges.set(edgeId, edge);
                fromNode.connections.push(toId);
                toNode.connections.push(fromId);
                this.updateStats();
            }

            createThread(fromId, toId) {
                const threadId = `thread_${fromId}-${toId}`;
                if (this.threads.has(threadId) || this.threads.has(`thread_${toId}-${fromId}`)) return;
                
                const fromNode = this.nodes.get(fromId);
                const toNode = this.nodes.get(toId);
                
                if (!fromNode || !toNode) return;
                
                const thread = {
                    id: threadId,
                    fromId: fromId,
                    toId: toId,
                    type: 'thread',
                    thickness: 1,
                    color: '#8000ff',
                    opacity: 0.4,
                    animated: true,
                    createdAt: new Date().toISOString()
                };
                
                this.threads.set(threadId, thread);
                fromNode.connections.push(toId);
                toNode.connections.push(fromId);
                this.updateStats();
            }

            enterConnectionMode() {
                this.exitAllModes();
                this.connectionMode = true;
                this.connectionStart = null;
                document.getElementById('connectionMode').style.display = 'block';
                document.getElementById('modeIndicator').textContent = 'Режим связей';
                this.hideContextMenu();
            }

            enterThreadMode() {
                this.exitAllModes();
                this.threadMode = true;
                this.connectionStart = null;
                document.getElementById('threadMode').style.display = 'block';
                document.getElementById('modeIndicator').textContent = 'Режим нитей';
                this.hideContextMenu();
            }

            exitAllModes() {
                this.connectionMode = false;
                this.threadMode = false;
                if (this.connectionStart) {
                    this.connectionStart.selected = false;
                    this.connectionStart = null;
                }
                document.getElementById('connectionMode').style.display = 'none';
                document.getElementById('threadMode').style.display = 'none';
                document.getElementById('modeIndicator').textContent = 'Режим создания';
            }

            selectAll() {
                this.selectedNodes.clear();
                this.nodes.forEach(node => {
                    node.selected = true;
                    this.selectedNodes.add(node.id);
                });
                this.hideContextMenu();
            }

            deleteSelected() {
                if (this.selectedNodes.size === 0 && this.rightClickedNode) {
                    this.selectedNodes.add(this.rightClickedNode.id);
                }
                
                if (this.selectedNodes.size === 0) return;
                
                this.selectedNodes.forEach(nodeId => {
                    // Remove edges
                    const edgesToRemove = [];
                    this.edges.forEach((edge, edgeId) => {
                        if (edge.fromId === nodeId || edge.toId === nodeId) {
                            edgesToRemove.push(edgeId);
                        }
                    });
                    edgesToRemove.forEach(edgeId => this.edges.delete(edgeId));
                    
                    // Remove threads
                    const threadsToRemove = [];
                    this.threads.forEach((thread, threadId) => {
                        if (thread.fromId === nodeId || thread.toId === nodeId) {
                            threadsToRemove.push(threadId);
                        }
                    });
                    threadsToRemove.forEach(threadId => this.threads.delete(threadId));
                    
                    // Remove node
                    this.nodes.delete(nodeId);
                });
                
                this.selectedNodes.clear();
                this.rightClickedNode = null;
                this.updateStats();
            }

            // New functions for advanced features
            editSelectedNode() {
                if (!this.rightClickedNode) return;
                
                const node = this.rightClickedNode;
                const newName = prompt('Новое название:', node.name);
                if (newName && newName.trim()) {
                    node.name = newName.trim();
                }
                
                const newDescription = prompt('Новое описание:', node.description || '');
                if (newDescription !== null) {
                    node.description = newDescription.trim();
                }
                
                this.hideContextMenu();
            }

            duplicateSelectedNode() {
                if (!this.rightClickedNode) return;
                
                const original = this.rightClickedNode;
                const newPosition = {
                    x: original.x + 50,
                    y: original.y + 50
                };
                
                this.createCustomNode(
                    original.name + ' (копия)',
                    original.type,
                    original.color,
                    original.description,
                    newPosition
                );
                
                this.hideContextMenu();
            }

            deleteSelectedNode() {
                if (!this.rightClickedNode) return;
                
                if (confirm(`Удалить узел "${this.rightClickedNode.name}"?`)) {
                    this.selectedNodes.clear();
                    this.selectedNodes.add(this.rightClickedNode.id);
                    this.deleteSelected();
                }
                
                this.hideContextMenu();
            }

            isolateNode() {
                if (!this.rightClickedNode) return;
                
                // Hide all nodes except the selected one and its direct connections
                const targetNode = this.rightClickedNode;
                const connectedNodeIds = new Set([targetNode.id]);
                
                // Add directly connected nodes
                this.edges.forEach(edge => {
                    if (edge.fromId === targetNode.id) connectedNodeIds.add(edge.toId);
                    if (edge.toId === targetNode.id) connectedNodeIds.add(edge.fromId);
                });
                
                this.threads.forEach(thread => {
                    if (thread.fromId === targetNode.id) connectedNodeIds.add(thread.toId);
                    if (thread.toId === targetNode.id) connectedNodeIds.add(thread.fromId);
                });
                
                // Hide unconnected nodes
                this.nodes.forEach(node => {
                    node.hidden = !connectedNodeIds.has(node.id);
                });
                
                this.hideContextMenu();
            }

            showNodeConnections() {
                if (!this.rightClickedNode) return;
                
                const connections = this.rightClickedNode.connections;
                if (connections.length === 0) {
                    alert('У этого узла нет связей');
                    return;
                }
                
                let message = `Связи узла "${this.rightClickedNode.name}":\n\n`;
                connections.forEach(nodeId => {
                    const connectedNode = this.nodes.get(nodeId);
                    if (connectedNode) {
                        message += `• ${connectedNode.name} (${connectedNode.type})\n`;
                    }
                });
                
                alert(message);
                this.hideContextMenu();
            }

            exportData() {
                const data = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    nodes: Array.from(this.nodes.values()),
                    edges: Array.from(this.edges.values()),
                    threads: Array.from(this.threads.values())
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `osint_galaxy_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.hideContextMenu();
            }

            importData() {
                document.getElementById('fileInput').click();
                this.hideContextMenu();
            }

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.version && data.nodes) {
                            // Clear existing data
                            this.nodes.clear();
                            this.edges.clear();
                            this.threads.clear();
                            
                            // Import nodes
                            data.nodes.forEach(nodeData => {
                                this.nodes.set(nodeData.id, nodeData);
                            });
                            
                            // Import edges
                            data.edges.forEach(edgeData => {
                                this.edges.set(edgeData.id, edgeData);
                            });
                            
                            // Import threads
                            if (data.threads) {
                                data.threads.forEach(threadData => {
                                    this.threads.set(threadData.id, threadData);
                                });
                            }
                            
                            this.updateStats();
                            alert('Данные успешно импортированы!');
                        } else {
                            throw new Error('Неверный формат файла');
                        }
                    } catch (error) {
                        alert('Ошибка при импорте файла: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            }

            takeScreenshot() {
                // Create a temporary canvas with white background
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                
                // Fill with white background
                tempCtx.fillStyle = '#ffffff';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Draw the current canvas content
                tempCtx.drawImage(this.canvas, 0, 0);
                
                // Download the screenshot
                const link = document.createElement('a');
                link.download = `osint_galaxy_screenshot_${new Date().toISOString().split('T')[0]}.png`;
                link.href = tempCanvas.toDataURL();
                link.click();
                
                this.hideContextMenu();
            }

            clearAll() {
                if (this.nodes.size === 0) return;
                
                if (confirm('Удалить все узлы и связи?')) {
                    this.nodes.clear();
                    this.edges.clear();
                    this.threads.clear();
                    this.selectedNodes.clear();
                    this.rightClickedNode = null;
                    this.updateStats();
                }
                this.hideContextMenu();
            }

            resetView() {
                this.viewOffset = { x: 0, y: 0 };
                this.zoom = 1;
                // Unhide all nodes
                this.nodes.forEach(node => {
                    node.hidden = false;
                });
                this.hideContextMenu();
            }

            updateStats() {
                document.getElementById('nodeCount').textContent = this.nodes.size;
                document.getElementById('edgeCount').textContent = this.edges.size;
                document.getElementById('threadCount').textContent = this.threads.size;
            }

            drawNode(node) {
                if (node.hidden) return;
                
                const x = node.x * this.zoom + this.viewOffset.x;
                const y = node.y * this.zoom + this.viewOffset.y;
                const radius = node.radius * this.zoom;
                
                // Node glow
                if (node.selected) {
                    const gradient = this.ctx.createRadialGradient(x, y, 0, x, y, radius * 2);
                    gradient.addColorStop(0, node.color + '80');
                    gradient.addColorStop(1, 'transparent');
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, radius * 2, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                // Node body
                const gradient = this.ctx.createRadialGradient(x, y, 0, x, y, radius);
                gradient.addColorStop(0, node.color);
                gradient.addColorStop(0.7, node.color);
                gradient.addColorStop(1, this.adjustBrightness(node.color, -0.3));
                
                this.ctx.fillStyle = gradient;
                this.ctx.beginPath();
                this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Node border
                this.ctx.strokeStyle = node.selected ? '#ffffff' : this.adjustBrightness(node.color, 0.2);
                this.ctx.lineWidth = node.selected ? 3 : 1;
                this.ctx.stroke();
                
                // Node icon using modern SVG-based approach
                this.drawNodeIcon(node, x, y, radius);
                
                // Node label
                if (this.zoom > 0.8) {
                    this.ctx.font = `${Math.max(8, 12 * this.zoom)}px Arial`;
                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(node.name, x, y + radius + 15 * this.zoom);
                }
            }

            drawNodeIcon(node, x, y, radius) {
                // Draw modern icon based on node type
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = `${Math.max(10, radius * 0.6)}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                const icon = this.getNodeIcon(node.type);
                this.ctx.fillText(icon, x, y);
            }

            drawEdge(edge) {
                const fromNode = this.nodes.get(edge.fromId);
                const toNode = this.nodes.get(edge.toId);
                
                if (!fromNode || !toNode || fromNode.hidden || toNode.hidden) return;
                
                const x1 = fromNode.x * this.zoom + this.viewOffset.x;
                const y1 = fromNode.y * this.zoom + this.viewOffset.y;
                const x2 = toNode.x * this.zoom + this.viewOffset.x;
                const y2 = toNode.y * this.zoom + this.viewOffset.y;
                
                this.ctx.strokeStyle = edge.color;
                this.ctx.globalAlpha = edge.opacity;
                this.ctx.lineWidth = edge.thickness * this.zoom;
                this.ctx.lineCap = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
                
                this.ctx.globalAlpha = 1;
            }

            drawThread(thread) {
                const fromNode = this.nodes.get(thread.fromId);
                const toNode = this.nodes.get(thread.toId);
                
                if (!fromNode || !toNode || fromNode.hidden || toNode.hidden) return;
                
                const x1 = fromNode.x * this.zoom + this.viewOffset.x;
                const y1 = fromNode.y * this.zoom + this.viewOffset.y;
                const x2 = toNode.x * this.zoom + this.viewOffset.x;
                const y2 = toNode.y * this.zoom + this.viewOffset.y;
                
                // Animated thread effect
                const time = Date.now() * 0.005;
                const segments = 20;
                const amplitude = 5 * this.zoom;
                
                this.ctx.strokeStyle = thread.color;
                this.ctx.globalAlpha = thread.opacity;
                this.ctx.lineWidth = thread.thickness * this.zoom;
                this.ctx.lineCap = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                
                for (let i = 1; i <= segments; i++) {
                    const t = i / segments;
                    const x = x1 + (x2 - x1) * t;
                    const y = y1 + (y2 - y1) * t;
                    
                    // Add wave effect
                    const wave = Math.sin(t * Math.PI * 4 + time) * amplitude * Math.sin(t * Math.PI);
                    const perpX = -(y2 - y1) / Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                    const perpY = (x2 - x1) / Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                    
                    this.ctx.lineTo(x + perpX * wave, y + perpY * wave);
                }
                
                this.ctx.stroke();
                this.ctx.globalAlpha = 1;
            }

            getNodeIcon(type) {
                const icons = {
                    person: '👤',
                    email: '✉',
                    phone: '📞',
                    facebook: '📘',
                    twitter: '🐦',
                    instagram: '📷',
                    linkedin: '💼',
                    telegram: '📨',
                    whatsapp: '💬',
                    vkontakte: '🔵',
                    youtube: '📺',
                    tiktok: '🎵',
                    discord: '🎮',
                    github: '⚙',
                    domain: '🌐',
                    location: '📍',
                    document: '📄',
                    ip: '🖧',
                    custom: '⚙'
                };
                return icons[type] || '❓';
            }

            adjustBrightness(color, amount) {
                const hex = color.replace('#', '');
                const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount * 255));
                const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount * 255));
                const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount * 255));
                return `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
            }

            onWindowResize() {
                this.initCanvas();
            }
        }

        // Музыкальный плеер
        class MusicPlayer {
            constructor() {
                this.audio = new Audio();
                this.playlist = [];
                this.currentTrackIndex = -1;
                this.isPlaying = false;
                this.volume = 0.7;
                
                this.setupPlayer();
                this.loadPlaylist();
            }
            
            setupPlayer() {
                this.audio.volume = this.volume;
                
                // Обновление прогресса
                this.audio.addEventListener('timeupdate', () => {
                    const progress = (this.audio.currentTime / this.audio.duration) * 100 || 0;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                });
                
                // Следующий трек по окончании
                this.audio.addEventListener('ended', () => {
                    this.nextTrack();
                });
                
                // Обработчик громкости
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    this.volume = parseFloat(e.target.value);
                    this.audio.volume = this.volume;
                });
                
                // Клик по прогресс-бару
                document.getElementById('progressContainer').addEventListener('click', (e) => {
                    const rect = e.target.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    this.audio.currentTime = percent * this.audio.duration;
                });
            }
            
            loadPlaylist() {
                this.playlist = [
                    { title: "I Dont Want To Feel This", file: "music/I Dont Want To Feel This Lonesome- Demo.mp3" },
                    { title: "Константин_Ступин_Когда_Я_Умер", file: "music/Константин_Ступин_Когда_Я_Умер_16_07_2015.mp3" },
                    { title: "Корсары_Константин_Ступин_17_05_2014", file: "music/Корсары_Константин_Ступин_17_05_2014" }
                ];
                
                this.renderPlaylist();
            }
            
            renderPlaylist() {
                const trackList = document.getElementById('trackList');
                trackList.innerHTML = '';
                
                this.playlist.forEach((track, index) => {
                    const trackItem = document.createElement('div');
                    trackItem.className = 'track-item';
                    trackItem.textContent = `${index + 1}. ${track.title}`;
                    trackItem.dataset.index = index;
                    
                    trackItem.addEventListener('click', () => {
                        this.playTrack(index);
                    });
                    
                    trackList.appendChild(trackItem);
                });
            }
            
            playTrack(index) {
                if (index < 0 || index >= this.playlist.length) return;
                
                this.currentTrackIndex = index;
                const track = this.playlist[index];
                
                // Обновляем UI
                document.getElementById('trackInfo').textContent = track.title;
                document.querySelectorAll('.track-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.track-item[data-index="${index}"]`).classList.add('active');
                
                // Загружаем и воспроизводим трек
                this.audio.src = track.file;
                this.audio.load();
                this.audio.play();
                this.isPlaying = true;
                document.getElementById('playBtn').textContent = '⏸';
            }
            
            togglePlay() {
                if (this.currentTrackIndex === -1 && this.playlist.length > 0) {
                    this.playTrack(0);
                    return;
                }
                
                if (this.isPlaying) {
                    this.audio.pause();
                    this.isPlaying = false;
                    document.getElementById('playBtn').textContent = '▶';
                } else {
                    this.audio.play();
                    this.isPlaying = true;
                    document.getElementById('playBtn').textContent = '⏸';
                }
            }
            
            prevTrack() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentTrackIndex - 1;
                if (newIndex < 0) newIndex = this.playlist.length - 1;
                this.playTrack(newIndex);
            }
            
            nextTrack() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentTrackIndex + 1;
                if (newIndex >= this.playlist.length) newIndex = 0;
                this.playTrack(newIndex);
            }
        }

        // Глобальные экземпляры
        let galaxy;
        let musicPlayer;

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            galaxy = new GalaxyOSINT();
            musicPlayer = new MusicPlayer();
            
            // Переключение музыкальной панели
            document.getElementById('musicPanel').addEventListener('click', (e) => {
                if (e.target.closest('.music-content') === null) {
                    const panel = document.getElementById('musicPanel');
                    panel.classList.toggle('expanded');
                }
            });
            
            // Горячие клавиши для музыки
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        musicPlayer.togglePlay();
                    }
                }
                
                if (e.key === 'ArrowLeft') {
                    musicPlayer.prevTrack();
                }
                
                if (e.key === 'ArrowRight') {
                    musicPlayer.nextTrack();
                }
            });
        });

        // UI Functions
        function toggleSubmenu(id) {
            const submenu = document.getElementById(id);
            const isOpen = submenu.classList.contains('open');
            
            // Close all submenus first
            document.querySelectorAll('.submenu').forEach(sub => sub.classList.remove('open'));
            
            // Open the clicked submenu if it wasn't already open
            if (!isOpen) {
                submenu.classList.add('open');
            }
        }

        function openNodeCreator() {
            galaxy.openNodeCreator();
        }

        function closeModal() {
            galaxy.closeModal();
        }

        function createNode() {
            galaxy.createNode();
        }

        function quickCreateNode(type) {
            galaxy.quickCreateNode(type);
        }

        function enterConnectionMode() {
            galaxy.enterConnectionMode();
        }

        function enterThreadMode() {
            galaxy.enterThreadMode();
        }

        function selectAll() {
            galaxy.selectAll();
        }

        function clearAll() {
            galaxy.clearAll();
        }

        function resetView() {
            galaxy.resetView();
        }

        // New advanced functions
        function editSelectedNode() {
            galaxy.editSelectedNode();
        }

        function duplicateSelectedNode() {
            galaxy.duplicateSelectedNode();
        }

        function deleteSelectedNode() {
            galaxy.deleteSelectedNode();
        }

        function isolateNode() {
            galaxy.isolateNode();
        }

        function showNodeConnections() {
            galaxy.showNodeConnections();
        }

        function exportData() {
            galaxy.exportData();
        }

        function importData() {
            galaxy.importData();
        }

        function takeScreenshot() {
            galaxy.takeScreenshot();
        }

        function handleFileImport(event) {
            galaxy.handleFileImport(event);
        }

        // Music control functions
        function togglePlay() {
            musicPlayer.togglePlay();
        }

        function prevTrack() {
            musicPlayer.prevTrack();
        }

        function nextTrack() {
            musicPlayer.nextTrack();
        }

        // Color selection
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('color-option')) {
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        // Enter key in modal
        document.getElementById('nodeName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createNode();
            }
        });

        // Prevent context menu on other elements
        document.addEventListener('contextmenu', (e) => {
            if (e.target !== galaxy?.canvas) {
                e.preventDefault();
            }
        });

        // Keyboard shortcuts info
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') {
                e.preventDefault();
                alert(`Горячие клавиши:
                
N - Создать новый узел
C - Режим связей
T - Режим нитей
A - Выбрать все (Ctrl+A)
Delete/Backspace - Удалить выбранные
Space - Сбросить вид
Escape - Выйти из режимов/закрыть меню
Ctrl+S - Экспорт данных
M - Музыкальная панель
F1 - Показать эту справку

Правый клик - Контекстное меню
Колесо мыши - Масштабирование
Левая кнопка + перетаскивание - Перемещение вида`);
            }
        });
    </script>
</body>
</html>9